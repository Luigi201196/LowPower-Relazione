\chapter{Laboratorio 3: \\Clock gating, pipelining and parallelizing}
Durante questa esperienza di laboratorio verranno analizzate una serie di tecniche per ridurre i consumi mediante l'ottimizzazione dell'architettura dei circuiti.
\section{A first approach to clock gating}
Un prima tecnica utilizzata per ridurre i consumi andando a lavorare sull'architettura è il \textit{Clock Gating}. Questa tecnica permette di "staccare" il clock ad un determinato blocco del mio circuito, quando questo non deve lavorare. Un circuito di massima è riportato in Figura \ref{clock_gating}. \\
\begin{figure}[!htb]
	\centering
	\includegraphics[scale=0.60]{immagini/clock_gating}
	\caption{\textit{Schema implementativo della tecnica del Clock Gating}}
	\label{clock_gating}
\end{figure}
\newpage
\noindent Nella prima parte dell'esperienza viene chiesto di analizzare il file \textit{ckgbug.vhd} che contiene la descrizione VHDL di una struttura composta da due registri in cascata, denominati L1 ed L2. La tecnica del clock gating viene applicata al secondo registro, mediante una AND tra il clock e un segnale di ENABLE. \\
Bisogna prestare attenzione al fatto che i segnali di ingresso dei due registri (D1 e D2) siano rispettivamente \textit{std\_logic\_vector (7 downto 0)} e \textit{std\_logic\_vector (0 to 7}. \\
In una prima simulazione, si forza il segnale D1 al valore '01111111' e, attivando il segnale di ENABLE, ci si aspetterebbe che D2, al colpo di clock successivo, vada al valore '111111101' e che l'uscita di L2, denominata D3, vada al valore '01111111' al colpo di clock ancora successivo. In realtà la simulazione porta al risultato in Figura \ref{clock_gat1}.
\begin{figure}[!htb]
	\centering
	\includegraphics[scale=0.8]{immagini/clock_gating1}
	\caption{\textit{Schema implementativo della tecnica del Clock Gating}}
	\label{clock_gat1}
\end{figure}
Si può ben notare come l'uscita D3 dopi esattamente D1 dopo un solo colpo di clock. Questo è dovuto al fatto che il clock gated arriva a L2 un "passo di simulazione" dopo L1, perchè il simulatore programma il calcolo dell'uscita AND dopo l'assegnazione del clock. Quindi accade come se l'AND avesse un ritardo interno. \\
La traccia suggerisce che si può risolvere questo inconveniente andando ad aggiungere un ritardo \textit{Clock-to-Output} pari a 0.1 ps all'uscita del generico Flip-Flop. Andando a risimulare il file, si ottiene il comportamento desiderato, che viene riportato in Figura \ref{clock_gat2}. \\
\newpage
\begin{figure}[!htb]
	\centering
	\includegraphics[scale=0.8]{immagini/clock_gating2}
	\caption{\textit{Schema implementativo della tecnica del Clock Gating}}
	\label{clock_gat2}
\end{figure}
\noindent Infine si aggiunge un ulteriore ritardo alla porta AND pari a 0.2 ps, ossia un tempo superiore a quello \textit{Clock-to-Output} inserito in precendeza. In questo modo si va a violtare il $t_{hold}$ e dunque il circuito ritorna nella situazione precendete con un funzionamento non corretto. Il risultato della simulazione è riportato in Figura \ref{clock_gat3}. \\
\begin{figure}[!htb]
	\centering
	\includegraphics[scale=0.8]{immagini/clock_gating3}
	\caption{\textit{Schema implementativo della tecnica del Clock Gating}}
	\label{clock_gat3}
\end{figure}
\newpage
\section{Clock Gating for a complex circuit}
Nella seguente sezione viene chiesto di analizzare il funzionamento e in seguito il consumo di potenza, applicando il concetto del clock gating, nel circuito illustrato in Figura \ref{circuito_3_2}.\\
\begin{figure}[!htb]
	\centering
	\includegraphics[scale=0.8]{immagini/circuito_3_2}
	\caption{\textit{Schema implementativo della tecnica del Clock Gating}}
	\label{circuito_3_2}
\end{figure}
\\
Si prova, esclusivamente a livello cartaceo ad applicare la tecnica del Clock Gating al circuito in figura, ottenendo il circuito in Figura \ref{circuito_3_3}.\\
\begin{figure}[!htb]
	\centering
	\includegraphics[scale=0.8]{immagini/circuito_3_2}
	\caption{\textit{Schema implementativo della tecnica del Clock Gating}}
	\label{circuito_3_3}
\end{figure}
\\
Si è proceduto dunque alla sintesi del circuito, sempre tramite \textit{Synopsis}, creando un clock con periodo pari a 5 s. Tramite il comando \textit{report\_power -include\_input\_nets} si è potuto ricavare un resoconto dei contributi di potenza dissipata, che vengono riportati in Figura \ref{3_1}. \\
\begin{figure}[!htb]
	\centering
	\includegraphics[scale=0.8]{immagini/3_1}
	\caption{\textit{Schema implementativo della tecnica del Clock Gating}}
	\label{3_1}
\end{figure}
\\
Si è poi andato ad eseguire un'analisi più dettagliata dei contributi tramite il comando \textit{report\_power -net -include\_input\_nets}, che viene riportato in Figura \ref{3_2}. \\
\begin{figure}[!htb]
	\centering
	\includegraphics[scale=0.8]{immagini/3_2}
	\caption{\textit{Schema implementativo della tecnica del Clock Gating}}
	\label{3_2}
\end{figure}
\\
Come si può ben notare dalla quarta colonna, il toogle rate dei vari ingressi presenta una \textit{static probability} pari a 0.5, che non risulta essere un valore sempre ragionevole. \\
Questo valore viene assegnato di default dal software, che però, tramite degli appositi comandi, permette di settare valori diversi di Toogle Rate a determinati segnali. Si è allora modificato il toogle rate del clock e del reset portandoli rispettivamente a 2 e a 0. Queste modifiche portano ad un risparmio di potenza del 20\% rispetto al caso precedente. Il report di potenza risultante viene raffigurato in Figura \ref{3_3}. \\
\begin{figure}[!htb]
	\centering
	\includegraphics[scale=0.8]{immagini/3_3}
	\caption{\textit{Schema implementativo della tecnica del Clock Gating}}
	\label{3_3}
\end{figure}
\\
Si va ora a modificare anche la probabilità degli input, portando sia INCA che INCB ad un Toogle Rate pari a 0.12. Si ottiene allora un risparmio ulteriore di potenza, come testimoniato da Power Report riportati in Figura \ref{3_4} e \ref{3_5}. \\
\begin{figure}[!htb]
	\centering
	\includegraphics[scale=0.8]{immagini/3_4}
	\caption{\textit{Schema implementativo della tecnica del Clock Gating}}
	\label{3_4}
\end{figure}
\begin{figure}[!htb]
	\centering
	\includegraphics[scale=0.8]{immagini/3_5}
	\caption{\textit{Schema implementativo della tecnica del Clock Gating}}
	\label{3_5}
\end{figure}
\newpage
\noindent Infine, tramite il comando \textit{report cell}, si riesce ad ottenere il numero di celle impiegate con la relativa dimensione. Viene riportato in Figura \ref{3_6}. Si può ben notare come nel caso analizzato le celle siano 74 e l'area utilizzata sia $229.292007 \mu m^{2}$ \\
\begin{figure}[!htb]
	\centering
	\includegraphics[scale=0.65]{immagini/3_6}
	\caption{\textit{Schema implementativo della tecnica del Clock Gating}}
	\label{3_6}
\end{figure}
\newpage
Ora si ri-eseguono le medesime simulazioni, ma utilizzando il circuito dove è stato applicata la tecnica del Clock Gating. Inizialmente si sono lasciati tutti i parametri esattamente come la prima analisi, quindi tutte le probabilità pari a 0.5, e si è ottenuto comunque una potenza inferiore del 16\% rispetto al caso senza la tecnica del Clock Gating. Il tutto viene riportato in Figura \ref{3_7} e \ref{3_8}. \\
\begin{figure}[!htb]
	\centering
	\includegraphics[scale=0.65]{immagini/3_7}
	\caption{\textit{Schema implementativo della tecnica del Clock Gating}}
	\label{3_7}
\end{figure}
\begin{figure}[!htb]
	\centering
	\includegraphics[scale=0.65]{immagini/3_8}
	\caption{\textit{Schema implementativo della tecnica del Clock Gating}}
	\label{3_8}
\end{figure}
\newpage
Esattamente come prima è stata cambiata la probabilità di reset, clock e input per vedere come cambiano i valori di potenza, portandole rispettivamente a 0, 0.5, 0.12.
Si è eseguito il comando \textit{report\_power -include\_input\_nets} e si sono analizzati i report di potenza che sono riportati in Figura \ref{3_9} e \ref{3_10}.\\
\begin{figure}[!htb]
	\centering
	\includegraphics[scale=0.65]{immagini/3_9}
	\caption{\textit{Schema implementativo della tecnica del Clock Gating}}
	\label{3_9}
\end{figure}
\begin{figure}[!htb]
	\centering
	\includegraphics[scale=0.65]{immagini/3_10}
	\caption{\textit{Schema implementativo della tecnica del Clock Gating}}
	\label{3_10}
\end{figure}
\newpage

Si può notare come si è ottenuto un risparmio del 41\% rispetto al caso senza Clock Gating. \\
Infine si ri-esegue l'analisi tramite il report cell, raffigurato in Figura \ref{3_11}. Si può notare come ora il numero di celle sia aumentato e con esso anche l'area.\\
Rispetto al caso senza Clock Gating ho ora un'area pari a $238.0700005 \mu m^{2}$ e un numero di celle pari a 78. L'aumento dell'area è uno degli svantaggi della tecnica che Clock Gating, ma comunque, in questa situazione, si tratta di un'incremento pari solo al 3.47\%, che risulta assolutamente accettabile visto che comporta un risparmio di potenza pari al 41\%.
\begin{figure}[!htb]
	\centering
	\includegraphics[scale=0.65]{immagini/3_11}
	\caption{\textit{Schema implementativo della tecnica del Clock Gating}}
	\label{3_11}
\end{figure}

\subsection{Some more clock gating?}
Il codice VHDL fornito è scritto in modo tale che il sintetizzatore non applichi la tecnica del Clock Gating sul registro di uscita: la motivazione risiede nell'utilizzo del costrutto \textit{if-else}, in quando nel codice iniziale non veniva dichiarati tutti i possibili casi tramite \textit{elsif}. Modificando opportunamente il codice VHDL,  riportato per interezza in Figura \ref{3_vhdl}, e inserendo le linee di codice riportate in Figura \ref{3_vhdl_2}, il sintetizzatore inserisce un blocco di clock gating sul regitro di uscita perchè interpreta che potrebbero esserci condizioni in cui non si andrà a scrivere sul registro di uscita.
\begin{figure}[!htb]
	\centering
	\includegraphics[scale=1]{immagini/3_vhdl}
	\caption{\textit{Schema implementativo della tecnica del Clock Gating}}
	\label{3_vhdl}
\end{figure}
\begin{figure}[!htb]
	\centering
	\includegraphics[scale=1.5]{immagini/3_vhdl_2}
	\caption{\textit{Schema implementativo della tecnica del Clock Gating}}
	\label{3_vhdl_2}
\end{figure}

\noindent Le modifiche al VHDL hanno portato al risultato richiesto, come si può notare in Figura \ref{3_12} che riporta il circuito sintetizzato e in Figura \ref{3_13} che riporta il particolare del blocco di Clock Gating inserito dal sintetizzatore.
\\
\begin{figure}[!htb]
	\centering
	\includegraphics[scale=0.5]{immagini/3_12}
	\caption{\textit{Schema implementativo della tecnica del Clock Gating}}
	\label{3_12}
\end{figure}
\begin{figure}[!htb]
	\centering
	\includegraphics[scale=1.5]{immagini/3_13}
	\caption{\textit{Schema implementativo della tecnica del Clock Gating}}
	\label{3_13}
\end{figure}
\\
Si eseguono ora le analisi dei consumi, esattamente come nel punto precedente.\\
Le prima analisi viene svolta senza la tecnica del Clock Gating e vengono lasciati i valori di Toogle Rate di default, quindi a 0.5. I power report ricavati sono riportati in Figura \ref{elsif1} e \ref{elsif2}.
\begin{figure}[!htb]
	\centering
	\includegraphics[scale=0.65]{immagini/elsif1}
	\caption{\textit{Schema implementativo della tecnica del Clock Gating}}
	\label{elsif1}
\end{figure}
\begin{figure}[!htb]
	\centering
	\includegraphics[scale=0.65]{immagini/elsif2}
	\caption{\textit{Schema implementativo della tecnica del Clock Gating}}
	\label{elsif2}
\end{figure}
Si può ben notare come rispetto al caso precedente, la potenza sia leggermente aumentata in quanto, avendo aggiunto un blocco di Clock Gating prima del registro di uscita, sono aumentati i gate totali che quindi portano ad una maggiore dissipazione di potenza. \\
Viene ora modificato il Toogle Rate del clock, del reset e degli ingressi, ottenendo i report in Figura \ref{elsif3} e \ref{elsif4}. L'aggiunta del blocco in uscita porta ad un primo risparmio di potenza pari a XX\% rispetto al caso analizzato al punto precedente. \\
\begin{figure}[!htb]
	\centering
	\includegraphics[scale=0.65]{immagini/elsif1}
	\caption{\textit{Schema implementativo della tecnica del Clock Gating}}
	\label{elsif3}
\end{figure}
\begin{figure}[!htb]
	\centering
	\includegraphics[scale=0.65]{immagini/elsif2}
	\caption{\textit{Schema implementativo della tecnica del Clock Gating}}
	\label{elsif4}
\end{figure}
\\
Si esegue infine il comando \textit{report cell} per ottenere l'area e il numero di celle utilizzate per la sintesi. Il report viene raffigurato i Figura \ref{elsif5}. \\
\newpage
\begin{figure}[!htb]
	\centering
	\includegraphics[scale=0.28]{immagini/elsif5}
	\caption{\textit{Schema implementativo della tecnica del Clock Gating}}
	\label{elsif5}
\end{figure}
\noindent Si può ben notare che ora il numero di celle è leggermente aumentato e di conseguenza anche l'area, in quanto si è aggiunta una logica prima del registro di uscita.\\
Si analizza allo stesso modo il circuito con l'aggiunta della tecnica del Clock Gating. Tutti i report, con lo stesso ordine dei punti precedenti, vengono riportati nelle Figure \ref{elsif6}, \ref{elsif7}, \ref{elsif8},\ref{elsif9}.\\
\begin{figure}[!htb]
	\centering
	\includegraphics[scale=0.65]{immagini/elsif6}
	\caption{\textit{Schema implementativo della tecnica del Clock Gating}}
	\label{elsif6}
\end{figure}
\begin{figure}[!htb]
	\centering
	\includegraphics[scale=0.65]{immagini/elsif7}
	\caption{\textit{Schema implementativo della tecnica del Clock Gating}}
	\label{elsif7}
\end{figure}
\begin{figure}[!htb]
	\centering
	\includegraphics[scale=0.65]{immagini/elsif8}
	\caption{\textit{Schema implementativo della tecnica del Clock Gating}}
	\label{elsif8}
\end{figure}
\begin{figure}[!htb]
	\centering
	\includegraphics[scale=0.65]{immagini/elsif9}
	\caption{\textit{Schema implementativo della tecnica del Clock Gating}}
	\label{elsif9}
\end{figure}
\newpage
\noindent Si può ben notare come nell'ultimo caso, quindi con i Toogle Rate modificati rispetto ai valori di default, la potenza sia aumentata del 18\% rispetto al medesimo caso ma senza il blocco di Clock Gating prima del registro di uscita. Ovviamente se invece si confronta l'ultimo risultato con il risultato dell'analisi senza il Clock Gating, ma con il blocco in uscita, si ottiene un risparmio di potenza considerevole.\\
Come ultima analisi si esegue il \textit{report cell} di quest'ultimo caso, riportato in Figura \ref{elsif10}, che testimonia come l'applicazione di questa tecnica comporti un aumento dell'area occupata a causa dell'inserimeto di una logica di controllo.
\begin{figure}[!htb]
	\centering
	\includegraphics[scale=0.28]{immagini/elsif10}
	\caption{\textit{Schema implementativo della tecnica del Clock Gating}}
	\label{elsif10}
\end{figure}
\\
Per sintetizzare si confronta la potenza dinamica totale prima e dopo l'introduzione del Clock Gating nel registro di uscita e si riportano i valori nella Tabella \ref{Tab3_1}. Si può ben notare come la potenza nel secondo caso sia leggermente aumentata in quanto si introduce una logica di controllo più complessa che impatta sulla switching activity della macchina.
\begin{table}[!h]\footnotesize
	\centering
	\begin{tabular}{|c|c|}
		\hline
		& \textbf{Potenza Dinamica Totale}\\
		\hline
		Prima & $19.2091 \mu W$\\
		Dopo & $22.6813 \mu W$\\
		\hline
	\end{tabular}
	\caption{\textit{Risultati tempi NAND simulazione ELDO}}
	\label{Tab3_1}
\end{table}

\section{Pipelining and parallelizing}





